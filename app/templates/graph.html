{% extends "base.html" %}
{% block title %}Knowledge Graph â€” RAG Second Brain{% endblock %}
{% block head %}
<script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
<style>#graph-container { width:100%; height:600px; border:1px solid #e5e7eb; border-radius:12px; background:#fff; }</style>
{% endblock %}

{% block content %}
<h1 class="text-2xl font-bold mb-2">ğŸ•¸ï¸ Knowledge Graph</h1>
<p class="text-sm text-gray-500 mb-4">Interactive entity relationship graph extracted from all documents. Node size = number of documents containing the entity. Click and drag to explore.</p>

<div class="flex gap-3 mb-4 text-xs">
    <span class="px-2 py-1 bg-blue-100 text-blue-700 rounded">ğŸ”µ 1-2 docs</span>
    <span class="px-2 py-1 bg-green-100 text-green-700 rounded">ğŸŸ¢ 3-5 docs</span>
    <span class="px-2 py-1 bg-orange-100 text-orange-700 rounded">ğŸŸ  6-10 docs</span>
    <span class="px-2 py-1 bg-red-100 text-red-700 rounded">ğŸ”´ 10+ docs</span>
</div>

<div id="graph-container"></div>

<div id="node-info" class="mt-4 bg-white rounded-xl shadow-sm border p-4 hidden">
    <h3 class="font-semibold" id="node-label"></h3>
    <p class="text-sm text-gray-500" id="node-detail"></p>
</div>
{% endblock %}

{% block scripts %}
<script>
fetch('/api/graph').then(r=>r.json()).then(data => {
    const colors = size => size <= 2 ? '#3b82f6' : size <= 5 ? '#22c55e' : size <= 10 ? '#f97316' : '#ef4444';
    const nodes = new vis.DataSet(data.nodes.map(n => ({
        id: n.id, label: n.label,
        size: Math.max(8, Math.min(30, n.size * 4)),
        color: { background: colors(n.size), border: colors(n.size), highlight: { background: '#0ea5e9' } },
        font: { size: Math.max(10, Math.min(16, n.size * 2)), color: '#374151' },
        title: `${n.label} (${n.size} docs)`
    })));
    // Limit edges for readability â€” only show edges between multi-doc entities
    const multiDoc = new Set(data.nodes.filter(n => n.size >= 2).map(n => n.id));
    const filteredEdges = data.edges.filter(e => multiDoc.has(e.from) && multiDoc.has(e.to));
    const edges = new vis.DataSet(filteredEdges.map((e,i) => ({
        id: i, from: e.from, to: e.to, color: { color: '#d1d5db', highlight: '#0ea5e9' }
    })));
    const container = document.getElementById('graph-container');
    const network = new vis.Network(container, { nodes, edges }, {
        physics: { solver: 'forceAtlas2Based', forceAtlas2Based: { gravitationalConstant: -30, springLength: 120 } },
        interaction: { hover: true, tooltipDelay: 100 },
        nodes: { shape: 'dot', borderWidth: 2 },
        edges: { width: 1, smooth: { type: 'continuous' } }
    });
    network.on('click', params => {
        if (params.nodes.length > 0) {
            const id = params.nodes[0];
            const node = data.nodes.find(n => n.id === id);
            document.getElementById('node-info').classList.remove('hidden');
            document.getElementById('node-label').textContent = `Entity: ${node.label}`;
            document.getElementById('node-detail').textContent = `Appears in ${node.size} document(s)`;
        }
    });
});
</script>
{% endblock %}
